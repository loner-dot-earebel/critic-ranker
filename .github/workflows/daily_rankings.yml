# force schedule parse
name: Daily Critic Rankings

on:
  schedule:
    # Runs every day at 11:00 PM PST (07:00 UTC next day)
    - cron: "0 7 * * *"
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 lxml

      # Step 4: Fetch Movies/TV
      - name: Fetch Movies and TV
        env:
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: python src/rank_all_media.py

      # Step 5: Fetch Music
      - name: Fetch Music
        run: python src/fetch_music_metacritic.py

      # Step 6: Fetch Games
      - name: Fetch Games
        run: python src/fetch_games_opencritic.py

      # Step 7: Merge All Critics (with medium counts)
      - name: Merge All Critics
        run: python src/merge_all_critics.py

      # Step 8: Preview top 5 rows of each CSV
      - name: Preview top 5 rows
        run: |
          echo "=== Top 5 Movies/TV ==="
          if [ -f outputs/critics_all_media_ranked.csv ]; then
            head -n 6 outputs/critics_all_media_ranked.csv
          else
            echo "File not found"
          fi

          echo "=== Top 5 Music ==="
          if [ -f outputs/music_metacritic_ranked.csv ]; then
            head -n 6 outputs/music_metacritic_ranked.csv
          else
            echo "File not found"
          fi

          echo "=== Top 5 Games ==="
          if [ -f data/games.csv ]; then
            head -n 6 data/games.csv
          else
            echo "File not found"
          fi

          echo "=== Top 5 Merged All Media ==="
          if [ -f outputs/critics_all_media_merged.csv ]; then
            head -n 6 outputs/critics_all_media_merged.csv
          else
            echo "File not found"
          fi

          echo "=== Top 5 Comedy/Humor ==="
          if [ -f outputs/critics_comedy_humor_merged.csv ]; then
            head -n 6 outputs/critics_comedy_humor_merged.csv
          else
            echo "File not found"
          fi

      # Step 9: Commit updated CSVs
      - name: Commit CSV outputs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add outputs/*.csv
          git diff-index --quiet HEAD || git commit -m "Daily rankings update"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
